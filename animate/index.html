<!DOCTYPE html>
<html>
	<head>
		<title>Animate</title>
		<style>
			html, body {
				margin: 0px;
				padding: 0px;
			}
		</style>
		<script src="../js/plugin/jquery-2.1.4.min.js"></script>
		<script src="../js/plugin/sprintf.js"></script>
		<script src="../js/animation.js"></script>
	</head>
	<body>

		<center>
			<object data="images/steve/steve.svg" type="image/svg+xml" id="steve"></object>
		</center>
		
		<script>
		
			/**
			 * Returns a random number between min (inclusive) and max (exclusive)
			 */
			function getRandomArbitrary(min, max) {
				return Math.random() * (max - min) + min;
			}
			
			function length_dir(len, degree) {
				var rad = degree * (Math.PI/180); 
				var x = len * Math.cos(rad);
				var y = len * Math.sin(rad);
				return [x,y];
			}
			
			var transform = function(cm, w, h, degree, base_scale, scale_x, scale_y, offset_x, offset_y, move_x, move_y) {
				var rad = degree * (Math.PI/180);
				var sx = base_scale + scale_x;
				var sy = base_scale + scale_y;
				var cos = Math.cos(rad);
				var sin = Math.sin(rad);
				var cx = w/2 + offset_x;
				var cy = h/2 + offset_y;
				var tx = (w * (1 - sx))/2 + move_x;
				var ty = (h * (1 - sy))/2 + move_y;
				var matrix = sprintf('matrix(%f,%f,%f,%f,%f,%f)', sx*cos, sy*sin, -sx*sin, sy*cos, (-cx*cos + cy*sin + cx)*sx + tx, (-cx*sin - cy*cos + cy)*sy + ty);
				cm.setAttribute('transform', matrix);
			};
			
			var sticker = function(obj, base_scale) {
				var interval = -1;
				var svgDoc = obj.contentDocument; 
				var cm = svgDoc.getElementById("mainGroup")
				var w = parseFloat($(cm).parent().attr("width"));
				var h = parseFloat($(cm).parent().attr("height"));
				
				var componants = $(cm).find('path,polygon,polyline').map(function(i, c) {
					return new component(c, w, h, base_scale);
				});
				
				var rightArm = [
					new component(svgDoc.getElementById("right_arm"), w, h, base_scale),
					new component(svgDoc.getElementById("right_wrist"), w, h, base_scale), 
					new component(svgDoc.getElementById("right_slieve"), w, h, base_scale), 
					new component(svgDoc.getElementById("right_hand"), w, h, base_scale)
				];
				var leftArm = [
					new component(svgDoc.getElementById("left_arm"), w, h, base_scale),
					new component(svgDoc.getElementById("left_wrist"), w, h, base_scale), 
					new component(svgDoc.getElementById("left_slieve"), w, h, base_scale), 
					new component(svgDoc.getElementById("left_hand"), w, h, base_scale)
				];
				var rightLeg = [
					new component(svgDoc.getElementById("right_thigh"), w, h, base_scale),
					new component(svgDoc.getElementById("right_limb"), w, h, base_scale), 
					new component(svgDoc.getElementById("right_foot"), w, h, base_scale)
				];
				var leftLeg = [
					new component(svgDoc.getElementById("left_thigh"), w, h, base_scale),
					new component(svgDoc.getElementById("left_limb"), w, h, base_scale), 
					new component(svgDoc.getElementById("left_foot"), w, h, base_scale)
				];
				var body = [
					new component(svgDoc.getElementById("body"), w, h, base_scale)
				];
				var neck = [
					new component(svgDoc.getElementById("neck"), w, h, base_scale)
				];
				var head = [
					new component(svgDoc.getElementById("left_ear"), w, h, base_scale),
					new component(svgDoc.getElementById("right_ear"), w, h, base_scale),
					new component(svgDoc.getElementById("face"), w, h, base_scale),
					new component(svgDoc.getElementById("left_eye"), w, h, base_scale),
					new component(svgDoc.getElementById("right_eye"), w, h, base_scale),
					new component(svgDoc.getElementById("mouth"), w, h, base_scale),
					new component(svgDoc.getElementById("hair"), w, h, base_scale)
				];

				
				this.wobble = function() {
					clearInterval(interval);
					
					var step = 0;
					var sinscale = 0.1;
					interval = setInterval(function(){ 
						transform(cm, w, h, 0, base_scale, Math.sin(step)*sinscale, -Math.sin(step)*sinscale, 0, 0, 0, 0);
						step += 0.05;
					}, 1);
				};
				
				this.jump = function() {
					clearInterval(interval);
					
					var step = 0;
					interval = setInterval(function(){ 
						transform(cm, w, h, 0, base_scale, 0, 0, 0, 0, 0, 10*(Math.sin(step)+1));
						step += 0.1;
					}, 1);
				};
				
				this.twirl = function() {
					clearInterval(interval);
					
					var step = 0;
					interval = setInterval(function() { 
						transform(cm, w, h, step, base_scale, 0, 0, 0, 0, 0, 0);
						step += 1;
					}, 1);
				};
				
				this.explode = function() {
					var i, l=componants.length;
					for(i=0; i<l; i+=1) {
						var c = componants[i];
						c.fly();
					}
				};
				
				this.kick = function() {
					clearInterval(interval);
					
					var step = 0;
					interval = setInterval(function() {
						transform(cm, w, h, 0, base_scale, 0, 0, 0, 0, 0, 0);
					
						var i, l=rightLeg.length;
						for(i=0; i<l; i+=1) {
							var c = rightLeg[i];
							transform(c.getComponent(), w, h, (Math.sin(step)+1)/2 * -60, 1, 0, 0, 220 - w/2, 280 - h/2, 0, 0);
						}
						step += 0.1;
						
						if (step > Math.PI*1.5) {
							clearInterval(interval);
						}
					}, 10);
				};
				
				this.walk = function() {
					clearInterval(interval);
					
					var step = 0;
					interval = setInterval(function() {
						transform(cm, w, h, 0, base_scale, 0, 0, 0, 0, 0, 0);
					
						var i, l=rightLeg.length;
						for(i=0; i<l; i+=1) {
							var c = rightLeg[i];
							transform(c.getComponent(), w, h, (Math.cos(step))/2 * -40, 1, 0, 0, 220 - w/2, 280 - h/2, 0, 0);
						}
						var i, l=leftLeg.length;
						for(i=0; i<l; i+=1) {
							var c = leftLeg[i];
							transform(c.getComponent(), w, h, (Math.sin(step))/2 * 40, 1, 0, 0, 179 - w/2, 280 - h/2, 0, 0);
						}
						step += 0.1;
						
						//if (step > Math.PI*1.5) {
						//	clearInterval(interval);
						//}
					}, 10);
				};
			};
			
			/**
				base_scale should be >=0 and <=1
			*/
			var component = function(cm, w, h, base_scale) {
				var jx = parseInt(cm.getAttribute("data-jointx"), 10);
				var jy = parseInt(cm.getAttribute("data-jointy"), 10);
				var interval = -1;
				
				var init_explode = function() {
					var obj = $(cm);
					obj.attr("speed_x", getRandomArbitrary(-2,2));
					obj.attr("speed_y", getRandomArbitrary(2,4));
					obj.attr("data-px", 0);
					obj.attr("data-py", 0);
				};
				
				this.getComponent = function() {
					return cm;
				};
				
				this.getJX = function() {
					return jx;
				};
				
				this.getJY = function() {
					return jy;
				};

				this.fly = function() {
					clearInterval(interval);
					
					init_explode();
					var step = 0, rot = 0;
					interval = setInterval(function() { 
						var obj = $(cm),
							vx = parseFloat(obj.attr("speed_x")),
							vy = parseFloat(obj.attr("speed_y")),
							px = parseFloat(obj.attr("data-px")),
							py = parseFloat(obj.attr("data-py"));
							
						px += vx;
						py -= vy;
						vy -= 0.1;
						
						transform(cm, w, h, rot, base_scale, 0, 0, 0, 0, px, py);
						
						obj.attr({
							"speed_y" : vy,
							"data-px" : px,
							"data-py" : py
						});
						
						rot += 0.2;
						step += 0.002;
						
						if (step > 0.3) {
							clearInterval(interval);
						}
					}, 1);
				};
			};
			

	
	
	
			var steve = document.getElementById("steve");
			steve.addEventListener("load", function() {
				var mainsvg = new sticker(steve, 1);
				
				//mainsvg.twirl();
				//mainsvg.jump();
				//mainsvg.wobble();
				//mainsvg.explode();
				//mainsvg.kick();
				mainsvg.walk();

			});
	
	
			/*
			var steve = document.getElementById("steve");
			steve.addEventListener("load", function() {
			
				var svgDoc = steve.contentDocument; 
				
				var right_arm = new component(svgDoc.getElementById("right_arm"), 1.0);
				var right_wrist = new component(svgDoc.getElementById("right_wrist"), 1.0); 
				
				var degree = 90, degree2 = 0;


				var interval = setInterval(function(){ 

					right_arm.rotate(degree);
					
					var data = length_dir(46, degree-45);
					var x = right_arm.getJX() + data[0];
					var y = right_arm.getJY() - data[1];
					
					//right_wrist.setAttribute('transform','translate(' + (x-264) + ' ' + (y-249) + ')' + ' ' + 'rotate(-' + degree2 + ' 264 249)');

					
					degree += 10;
					degree2 += 30;
				}, 50);
				
				//right_arm.addEventListener("mousedown",function(){
				//	alert('hello world!');
				//},false);   
			},false);
			*/

		</script>
	</body>

</html> 